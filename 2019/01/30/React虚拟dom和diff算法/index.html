<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> React虚拟dom和diff算法 · HarryPang's Blog</title><meta name="description" content="React虚拟dom和diff算法 - Harry Pang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://github.com/ZhangQiangQQ/atom.xml" title="HarryPang's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/2019/01/11/关于我" target="_self" class="nav-list-link">关于我</a></li><li class="nav-list-item"><a href="https://github.com/ZhangQiangQQ/" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">React虚拟dom和diff算法</h1><div class="post-info">2019年1月30日</div><div class="post-content"><h2 id="什么是虚拟dom？"><a href="#什么是虚拟dom？" class="headerlink" title="什么是虚拟dom？"></a>什么是虚拟dom？</h2><p>这就要从react如何渲染出页面开始<br>通常情况下的步骤是这样</p>
<ol>
<li>获取state数据</li>
<li>JSX模板</li>
<li>state+JSX模板结合，生成真实dom并显示</li>
</ol>
<p>这个是在state不发生变化的情况下，（state或者prop发生变化都会调用render函数，重新渲染页面）</p>
<p>state数据变化时，通常理解下应该是下面的步骤</p>
<ol>
<li>获取state数据</li>
<li>JSX模板</li>
<li>state数据+JSX模板结合，生成真实dom并显示</li>
<li>state数据发生变化</li>
<li>新的state数据+JSX模板结合，生成真实dom并显示</li>
</ol>
<p>这样可以实现，但是非常消耗性能，因为会渲染两次dom树，所以react就采用一种虚拟dom的方法来进行dom更新。</p>
<p>JSX转成dom流程</p>
<blockquote>
<p>用JSX语法时，渲染dom的流程：JSX——JS dom描述对象——真实dom</p>
</blockquote>
<p>具体步骤：</p>
<ol>
<li>获取state数据</li>
<li>JSX模板</li>
<li>生成虚拟dom（虚拟dom就是一个JS对象，里面包含了对真实dom的描述</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;div&apos;,&#123;id:&apos;a&apos;&#125;,[&apos;span&apos;,&#123;&#125;,&apos;hello&apos;]]</span><br></pre></td></tr></table></figure>
<ol start="4">
<li><p>用虚拟dom解构，生成真实dom并显示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&apos;a&apos;&gt;&lt;span&gt;hello&lt;/span&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>state数据发生变化（比如hello变成了hi）</p>
</li>
<li><p>生成新的虚拟dom</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;div&apos;,&#123;id:&apos;a&apos;&#125;,[&apos;span&apos;,&#123;&#125;,&apos;hi&apos;]]</span><br></pre></td></tr></table></figure>
</li>
<li><p>比较原始虚拟dom和新的虚拟dom的区别，找出区别是span里的内容</p>
</li>
<li>直接操作dom，只改变span里的内容</li>
</ol>
<h4 id="虚拟dom的好处"><a href="#虚拟dom的好处" class="headerlink" title="虚拟dom的好处"></a>虚拟dom的好处</h4><ol>
<li>性能提升，dom比对变成js对象比对</li>
<li>使得跨端应用得以实现（react native）<blockquote>
<p>在浏览器中可以用虚拟dom生成真实dom显示，在原生应用中也可以用虚拟dom生成对应的方式来显示页面</p>
</blockquote>
</li>
</ol>
<h2 id="虚拟dom中的diff算法"><a href="#虚拟dom中的diff算法" class="headerlink" title="虚拟dom中的diff算法"></a>虚拟dom中的diff算法</h2><p>在上面我们介绍了react中state变化时，dom是如何发生变化的，在第七步中比较原始虚拟dom和新的虚拟dom的区别采用的方法，就是diff算法（diffrence）</p>
<p>虚拟dom在什么时候会发生比对？没错，数据发生变化时，也就是调用setState时</p>
<p>react的虚拟dom其实是同级比较的</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/30/1689dac3232d3b6d?w=582&amp;h=300&amp;f=png&amp;s=69471" alt=""><br>如上图<br>他的对比步骤如下</p>
<ol>
<li>红色原始虚拟dom和新的虚拟dom，没有变化，保持不变，往下继续比对</li>
<li>蓝色原始虚拟dom和新的虚拟dom，没有变化，保持不变，往下继续比对</li>
<li>绿色原始虚拟dom和新的虚拟dom，没有变化，保持不变，往下继续比对，浅蓝色原始虚拟dom和新的虚拟dom，没有变化，保持不变，往下继续比对</li>
</ol>
<blockquote>
<p>但凡在上面哪一步骤出现不同，就不再继续比对，而是删除下面的全部节点，采用新的虚拟dom(例如：如果红色框的原始虚拟dom和新的虚拟dom不一致，那么就不在进行比对，采用新的虚拟dom来生成dom)</p>
</blockquote>
<h4 id="key的作用"><a href="#key的作用" class="headerlink" title="key的作用"></a>key的作用</h4><p>react利用key来识别组件，它是一种身份标识标识，来提高虚拟dom的比对速度看下面</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/30/1689dbb06ec80cda?w=477&amp;h=191&amp;f=png&amp;s=7412" alt=""><br>比如我要在abcde中添加一个f</p>
<p>如果我们没有key值，那我们就需要A比对一遍，B对比一遍，以此类推很好性能，而有了key，就像下面的图一样，我们很快就知道只有f与之前不同，提高了列表渲染的性能<br><img src="https://user-gold-cdn.xitu.io/2019/1/30/1689dbbc688199b4?w=565&amp;h=201&amp;f=png&amp;s=11659" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/02/09/webpack下build报错/" class="prev">PREV</a><a href="/2019/01/27/react生命周期/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="https://github.com/ZhangQiangQQ">Harry Pang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>